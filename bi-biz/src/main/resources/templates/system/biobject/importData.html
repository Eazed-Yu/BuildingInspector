<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:include="include :: header('导入桥梁构件数据')" />
    <th:block th:include="include :: bootstrap-fileinput-css" />
</head>
<body class="white-bg">
<div class="wrapper wrapper-content animated fadeInRight ibox-content">
    <form class="form-horizontal m" id="form-biobject-import">
        <div class="form-group">
            <label class="col-sm-3 control-label">JSON数据：</label>
            <div class="col-sm-8">
                <textarea name="jsonData" class="form-control" rows="10" required></textarea>
            </div>
        </div>
    </form>
</div>
<th:block th:include="include :: footer" />
<th:block th:include="include :: bootstrap-fileinput-js" />
<script type="text/javascript">
    var prefix = ctx + "system/biobject";

    $("#form-biobject-import").validate({
        rules: {
            jsonData: {
                required: true
            }
        },
        focusCleanup: true
    });

    function submitHandler() {
        if ($.validate.form()) {
            var jsonData = $("textarea[name='jsonData']").val();
            try {
                // 验证输入的是否为有效的JSON
                var parsedData = JSON.parse(jsonData);

                // 如果输入的不是数组，则将其转换为单元素数组
                var jsonArray = Array.isArray(parsedData) ? parsedData : [parsedData];

                // 将每个对象转换为字符串
                var stringArray = jsonArray.map(function(item) {
                    return JSON.stringify(item);
                });

                var config = {
                    url: prefix + "/importData",
                    type: "post",
                    dataType: "json",
                    contentType: "application/json",
                    data: JSON.stringify(stringArray),
                    success: function(result) {
                        if (result.code == web_status.SUCCESS) {
                            $.modal.closeAll();
                            $.modal.alertSuccess(result.msg);
                            $.table.refresh();
                        } else {
                            $.modal.alertError(result.msg);
                        }
                    }
                };
                $.ajax(config);
            } catch (e) {
                $.modal.alertError("JSON格式不正确，请检查输入");
            }
        }
    }

    /* 获取JSON模板 */
    $(function() {
        $.modal.loading("正在加载模板数据，请稍候...");
        $.ajax({
            type: "get",
            url: prefix + "/importTemplate",
            success: function(result) {
                $.modal.closeLoading();
                if (result.code == web_status.SUCCESS) {
                    $("textarea[name='jsonData']").val(result.msg);
                } else {
                    $.modal.alertError(result.msg || "获取模板失败");
                }
            },
            error: function(jqXHR, textStatus, errorThrown) {
                $.modal.closeLoading();
                $.modal.alertError("获取模板失败: " + textStatus);
            }
        });
    });
</script>
</body>
</html> 